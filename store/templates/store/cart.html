{% extends 'store/base.html' %}
{% load static %}
{% block title %}Ø³Ø¨Ø¯ Ø®Ø±ÛŒØ¯{% endblock %}
{% block content %}

<h2 class="text-center mb-4">ğŸ›’ Ø³Ø¨Ø¯ Ø®Ø±ÛŒØ¯ Ø´Ù…Ø§</h2>

<!-- Ù†Ù…Ø§ÛŒØ´ Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ÛŒ Ù…ÙˆÙÙ‚ÛŒØª ÛŒØ§ Ø®Ø·Ø§ -->
{% if messages %}
    {% for message in messages %}
    <div class="alert alert-info text-center">{{ message }}</div>
    {% endfor %}
{% endif %}

{% if cart.products.all %}
<div class="table-responsive">
    <table class="table table-bordered text-center align-middle">
        <thead class="table-dark">
            <tr>
                <th>ØªØµÙˆÛŒØ±</th>
                <th>Ù…Ø­ØµÙˆÙ„</th>
                <th>Ù‚ÛŒÙ…Øª</th>
                <th>Ø¹Ù…Ù„ÛŒØ§Øª</th>
            </tr>
        </thead>
        <tbody>
            {% for item in cart.products.all %}
            <tr id="product-row-{{ item.id }}">
                <td>
                    <img src="{{ item.image.url }}" alt="{{ item.name }}" class="img-fluid" style="max-width: 80px;">
                </td>
                <td>{{ item.name }}</td>
                <td>{{ item.price }} ØªÙˆÙ…Ø§Ù†</td>
                <td>
                    <button class="btn btn-danger btn-sm remove-product" data-product-id="{{ item.id }}">âŒ Ø­Ø°Ù</button>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- Ø¨Ø®Ø´ Ø«Ø¨Øª Ø³ÙØ§Ø±Ø´ -->
<div class="row">
    <div class="col-md-6 offset-md-6">
        <p class="h5 text-end">ğŸ’° Ù…Ø¬Ù…ÙˆØ¹: <strong id="total-price">{{ cart.total_price }}</strong> ØªÙˆÙ…Ø§Ù†</p>
        <form method="POST" id="order-form" action="{% url 'place_order' %}">
            {% csrf_token %}
            <div class="mb-3">
                <input type="text" name="address" class="form-control" placeholder="ğŸ“ Ø¢Ø¯Ø±Ø³ ØªØ­ÙˆÛŒÙ„ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯" required>
            </div>
            <button type="submit" class="btn btn-success w-100 fw-bold">âœ… Ø«Ø¨Øª Ø³ÙØ§Ø±Ø´</button>
        </form>
    </div>
</div>

{% else %}
<p class="text-center text-muted">ğŸ›’ Ø³Ø¨Ø¯ Ø®Ø±ÛŒØ¯ Ø´Ù…Ø§ Ø®Ø§Ù„ÛŒ Ø§Ø³Øª.</p>
{% endif %}

<script>
// Ø­Ø°Ù Ù…Ø­ØµÙˆÙ„ Ø§Ø² Ø³Ø¨Ø¯ Ø®Ø±ÛŒØ¯ Ø¨Ø§ AJAX
document.querySelectorAll(".remove-product").forEach(button => {
    button.addEventListener("click", function() {
        const productId = this.getAttribute("data-product-id");
        fetch(`/remove-product/${productId}/`, { 
            method: "POST",
            headers: { 
                "X-CSRFToken": "{{ csrf_token }}",
                "X-Requested-With": "XMLHttpRequest"
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Remove the product row from the table
                document.getElementById(`product-row-${productId}`).remove();
                // Update the total price
                document.getElementById("total-price").textContent = data.total_price;
                // Show a success message
                alert("Ù…Ø­ØµÙˆÙ„ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø­Ø°Ù Ø´Ø¯!");
            } else {
                alert("Ø®Ø·Ø§ Ø¯Ø± Ø­Ø°Ù Ù…Ø­ØµÙˆÙ„!");
            }
        })
        .catch(error => console.error("Ø®Ø·Ø§ Ø¯Ø± Ø­Ø°Ù Ù…Ø­ØµÙˆÙ„:", error));
    });
});

// Ø«Ø¨Øª Ø³ÙØ§Ø±Ø´ Ø¨Ø§ AJAX
document.getElementById("order-form").addEventListener("submit", function(e) {
    e.preventDefault();
    const form = this;

    fetch(form.action, {
        method: "POST",
        body: new FormData(form),
        headers: { 
            "X-Requested-With": "XMLHttpRequest",
            "X-CSRFToken": "{{ csrf_token }}"
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert("Ø³ÙØ§Ø±Ø´ Ø´Ù…Ø§ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø«Ø¨Øª Ø´Ø¯!");
            window.location.reload(); // Refresh the page to reflect changes
        } else {
            alert(data.error || "Ø®Ø·Ø§ Ø¯Ø± Ø«Ø¨Øª Ø³ÙØ§Ø±Ø´!");
        }
    })
    .catch(error => console.error("Ø®Ø·Ø§ Ø¯Ø± Ø«Ø¨Øª Ø³ÙØ§Ø±Ø´:", error));
});
</script>

{% endblock %}