{% extends "store/base.html" %}
{% load static %}
{% block title %}ุณุจุฏ ุฎุฑุฏ{% endblock %}
{% block content %}

<div class="container mt-5">
    <h2 class="text-center mb-4">๐ ุณุจุฏ ุฎุฑุฏ ุดูุง</h2>

    {% if cart.products.all %}
    <div class="table-responsive">
        <table class="table table-bordered text-center align-middle">
            <thead class="table-dark">
                <tr>
                    <th>ุชุตูุฑ</th>
                    <th>ูุญุตูู</th>
                    <th>ููุช</th>
                    <th>ุนููุงุช</th>
                </tr>
            </thead>
            <tbody>
                {% for item in cart.products.all %}
                <tr id="product-row-{{ item.id }}">
                    <td>
                        <img src="{{ item.main_image.url }}" alt="{{ item.name }}" class="img-fluid" style="max-width: 100px;">
                    </td>
                    <td>{{ item.name }}</td>
                    <td>{{ item.price }} ุชููุงู</td>
                    <td>
                        <form method="POST" action="{% url 'remove_product' item.id %}" class="remove-product-form">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-danger btn-sm">ุญุฐู</button>
                        </form>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <p class="text-center mt-3 text-muted">
        ูพุณ ุงุฒ ุชุงุฏ ุณุจุฏ ุฎุฑุฏ ู ุขุฏุฑุณุ ููฺฉุงุฑุงู ูุง ุจุฑุง ุชุงุฏ ุงู ุณูุงุฑุด ุชูุงุณ ุฎูุงููุฏ ฺฏุฑูุช.
    </p>

    <div class="row">
        <div class="col-md-6 offset-md-3">
            <p class="h5 text-end">๐ฐ ูุฌููุน: <span id="total-price">{{ cart.total_price }}</span> ุชููุงู</p>
            
            <form method="POST" id="order-form" action="{% url 'cart' %}">
                {% csrf_token %}
                <div class="mb-3">
                    <label for="address" class="form-label">๐ ุขุฏุฑุณ ุชุญูู</label>
                    <input type="text" name="address" id="address" class="form-control" placeholder="ุขุฏุฑุณ ุฑุง ูุงุฑุฏ ฺฉูุฏ..." required>
                    <button type="button" class="btn btn-outline-primary mt-2 w-100" onclick="getLocation()">๐ ุงูุชุฎุงุจ ููฺฉุดู ูู</button>
                </div>
                <button type="submit" class="btn btn-success w-100">โ ุซุจุช ุณูุงุฑุด</button>
            </form>
        </div>
    </div>

    <!-- ูพุงู ุชุฃุฏ ุณูุงุฑุด -->
    <div id="order-confirmation" class="alert alert-success text-center mt-4" style="display: none;"></div>

    {% else %}
    <p class="text-center text-muted">๐ ุณุจุฏ ุฎุฑุฏ ุดูุง ุฎุงู ุงุณุช.</p>
    {% endif %}
</div>

<script>
// ุญุฐู ูุญุตูู ุจุง ุงุณุชูุงุฏู ุงุฒ AJAX
document.querySelectorAll('.remove-product-form').forEach(function(form) {
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        const currentForm = this;
        fetch(currentForm.action, {
            method: 'POST',
            body: new FormData(currentForm),
            headers: { 'X-Requested-With': 'XMLHttpRequest' }
        })
        .then(response => response.json())
        .then(data => {
            if(data.success) {
                document.getElementById('product-row-' + data.product_id).remove();
                if(data.total_price !== undefined) {
                    document.getElementById('total-price').innerText = data.total_price;
                }
            } else {
                console.error("Error:", data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert("ุฎุทุง ุฏุฑ ุญุฐู ูุญุตูู. ูุทูุงู ุฏูุจุงุฑู ุชูุงุด ฺฉูุฏ.");
        });
    });
});

// ุฏุฑุงูุช ููฺฉุดู ุฌุบุฑุงูุง
function getLocation() {
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(showPosition, showError);
    } else {
        alert("ูุฑูุฑฺฏุฑ ุดูุง ุงุฒ ูููุนุชโุงุจ ูพุดุชุจุงู ููโฺฉูุฏ.");
    }
}

function showPosition(position) {
    let lat = position.coords.latitude;
    let lon = position.coords.longitude;
    let googleMapsUrl = `https://www.google.com/maps/search/?api=1&query=${lat},${lon}`;
    document.getElementById("address").value = `๐ ูููุนุช ุงูุชุฎุงุจ ุดูุง: ${googleMapsUrl}`;
}

function showError(error) {
    alert("ุฎุทุง ุฏุฑ ุฏุฑุงูุช ูููุนุช ูฺฉุงู.");
}

// ุซุจุช ุณูุงุฑุด ุจู ุตูุฑุช AJAX
document.getElementById("order-form").addEventListener("submit", function(e) {
    e.preventDefault();
    const form = this;
    fetch(form.action, {
        method: "POST",
        body: new FormData(form),
        headers: { "X-Requested-With": "XMLHttpRequest" }
    })
    .then(response => response.json())
    .then(data => {
        if(data.success) {
            // ููุงุด ูพุงู ููููุช
            const confirmation = document.getElementById("order-confirmation");
            confirmation.innerText = data.message;
            confirmation.style.display = "block";
            // Refresh the page after a short delay
            setTimeout(() => {
                window.location.reload();
            }, 2000);
        } else {
            alert(data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert("ุฎุทุง ุฏุฑ ุซุจุช ุณูุงุฑุด. ูุทูุงู ุฏูุจุงุฑู ุชูุงุด ฺฉูุฏ.");
    });
});
</script>

{% endblock %}